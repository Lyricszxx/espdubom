local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Camera = game.Workspace.CurrentCamera

local visibleColor = Color3.fromRGB(255, 0, 0)
local normalColor = Color3.fromRGB(255, 255, 255)

local function IsAlive(player)
    return player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0
end

local function IsVisible(player)
    local head = player.Character:FindFirstChild("Head")
    if head then
        local origin = Camera.CFrame.Position
        local direction = (head.Position - origin).unit * (head.Position - origin).Magnitude

        local raycastParams = RaycastParams.new()
        raycastParams.FilterDescendantsInstances = {Players.LocalPlayer.Character}
        raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

        local raycastResult = game.Workspace:Raycast(origin, direction, raycastParams)
        return not raycastResult or not raycastResult.Instance:IsDescendantOf(player.Character)
    end
    return false
end

local function CreateESP(player)
    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Size = UDim2.new(0, 100, 0, 50)
    BillboardGui.Adornee = player.Character:FindFirstChild("Head")
    BillboardGui.Parent = player.Character.Head

    local NameLabel = Instance.new("TextLabel")
    NameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    NameLabel.BackgroundTransparency = 1
    NameLabel.TextColor3 = normalColor
    NameLabel.TextScaled = true
    NameLabel.Parent = BillboardGui

    local HPLabel = Instance.new("TextLabel")
    HPLabel.Size = UDim2.new(1, 0, 0.5, 0)
    HPLabel.Position = UDim2.new(0, 0, 0.5, 0)
    HPLabel.BackgroundTransparency = 1
    HPLabel.TextColor3 = normalColor
    HPLabel.TextScaled = true
    HPLabel.Parent = BillboardGui

    local Outline = Instance.new("Highlight")
    Outline.Adornee = player.Character
    Outline.Parent = player.Character
    Outline.FillTransparency = 1
    Outline.OutlineColor = normalColor
    Outline.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop

    return BillboardGui, Outline, NameLabel, HPLabel
end

while true do
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            if player.Character and player.Character:FindFirstChild("Head") then
                local BillboardGui, Outline, NameLabel, HPLabel = CreateESP(player)

                RunService.RenderStepped:Connect(function()
                    if IsAlive(player) then
                        local humanoid = player.Character:FindFirstChild("Humanoid")
                        NameLabel.Text = player.Name
                        HPLabel.Text = "HP: " .. math.ceil(humanoid.Health)

                        if IsVisible(player) then
                            Outline.OutlineColor = visibleColor
                        else
                            Outline.OutlineColor = normalColor
                        end
                    else
                        BillboardGui:Destroy()
                        Outline:Destroy()
                    end
                end)
            end
        end
    end
    wait(1) -- Intervalo para evitar sobrecarga do loop
end

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        if character:FindFirstChild("Head") then
            CreateESP(player)
        end
    end)
end)

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Camera = game.Workspace.CurrentCamera

-- Cor para o outline vermelho quando o jogador está visível
local visibleColor = Color3.fromRGB(255, 0, 0)
-- Cor padrão quando o jogador está atrás de uma parede
local normalColor = Color3.fromRGB(255, 255, 255)

-- Função para verificar se o jogador está vivo
local function IsAlive(player)
    return player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0
end

-- Função para verificar a linha de visão (raycast)
local function IsVisible(player)
    local head = player.Character:FindFirstChild("Head")
    if head then
        local origin = Camera.CFrame.Position
        local direction = (head.Position - origin).unit * (head.Position - origin).Magnitude

        local raycastParams = RaycastParams.new()
        raycastParams.FilterDescendantsInstances = {Players.LocalPlayer.Character}
        raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

        local raycastResult = game.Workspace:Raycast(origin, direction, raycastParams)
        if raycastResult then
            if raycastResult.Instance:IsDescendantOf(player.Character) then
                return true
            else
                return false
            end
        else
            return true
        end
    end
    return false
end

-- Função para desenhar ESP e manter o tamanho fixo
local function CreateESP(player)
    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Size = UDim2.new(0, 50, 0, 25) -- Tamanho reduzido do ESP
    BillboardGui.Adornee = player.Character:FindFirstChild("Head")
    BillboardGui.Parent = player.Character.Head

    local NameLabel = Instance.new("TextLabel")
    NameLabel.Size = UDim2.new(1, 0, 1, 0)
    NameLabel.BackgroundTransparency = 1
    NameLabel.Text = player.Name
    NameLabel.TextColor3 = normalColor
    NameLabel.TextScaled = true
    NameLabel.Parent = BillboardGui

    local Outline = Instance.new("Highlight")
    Outline.Adornee = player.Character
    Outline.Parent = player.Character
    Outline.FillTransparency = 1
    Outline.OutlineColor = normalColor
    Outline.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop

    -- Atualiza a cor do outline com base na visibilidade
    local updateConnection
    updateConnection = RunService.RenderStepped:Connect(function()
        if IsAlive(player) then
            if IsVisible(player) then
                Outline.OutlineColor = visibleColor
            else
                Outline.OutlineColor = normalColor
            end
        else
            -- Verifica se o jogador morreu e desconecta o evento
            if player.Character:FindFirstChild("Humanoid").Health <= 0 then
                updateConnection:Disconnect() -- Desconecta quando o jogador morre
            end
        end
    end)
end

-- Função para configurar o ESP e outline para um jogador quando ele respawnar
local function ApplyESP(player)
    if player.Character and player.Character:FindFirstChild("Head") then
        CreateESP(player)
    end
    -- Reaplica o ESP sempre que o jogador reaparecer
    player.CharacterAdded:Connect(function(character)
        if character:FindFirstChild("Head") then
            CreateESP(player)
        end
    end)
end

-- Aplica o ESP para todos os jogadores existentes
for _, player in pairs(Players:GetPlayers()) do
    if player ~= Players.LocalPlayer then
        ApplyESP(player)
    end
end

-- Aplica o ESP para novos jogadores que entrarem no jogo
Players.PlayerAdded:Connect(function(player)
    ApplyESP(player)
end)

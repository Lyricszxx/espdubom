local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Camera = game.Workspace.CurrentCamera

local visibleColor = Color3.fromRGB(255, 0, 0)
local normalColor = Color3.fromRGB(255, 255, 255)

local function IsAlive(player)
    return player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0
end

local function IsVisible(player)
    local head = player.Character:FindFirstChild("Head")
    if head then
        local origin = Camera.CFrame.Position
        local direction = (head.Position - origin).unit * (head.Position - origin).Magnitude

        local raycastParams = RaycastParams.new()
        raycastParams.FilterDescendantsInstances = {Players.LocalPlayer.Character}
        raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

        local raycastResult = game.Workspace:Raycast(origin, direction, raycastParams)
        if raycastResult then
            return not raycastResult.Instance:IsDescendantOf(player.Character)
        end
        return true
    end
    return false
end

local function CreateESP(player)
    local BillboardGui = Instance.new("BillboardGui")
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Size = UDim2.new(0, 50, 0, 25)
    BillboardGui.Adornee = player.Character:FindFirstChild("Head")
    BillboardGui.Parent = player.Character.Head

    local NameLabel = Instance.new("TextLabel")
    NameLabel.Size = UDim2.new(1, 0, 1, 0)
    NameLabel.BackgroundTransparency = 1
    NameLabel.Text = player.Name
    NameLabel.TextColor3 = normalColor
    NameLabel.TextScaled = true
    NameLabel.Parent = BillboardGui

    local Outline = Instance.new("Highlight")
    Outline.Adornee = player.Character
    Outline.Parent = player.Character
    Outline.FillTransparency = 1
    Outline.OutlineColor = normalColor
    Outline.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop

    while true do
        if IsAlive(player) then
            if IsVisible(player) then
                Outline.OutlineColor = visibleColor
            else
                Outline.OutlineColor = normalColor
            end
        else
            BillboardGui:Destroy()
            Outline:Destroy()
            break
        end
        RunService.RenderStepped:Wait()
    end
end

for _, player in pairs(Players:GetPlayers()) do
    if player ~= Players.LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
        CreateESP(player)
    end
end

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        character:WaitForChild("Head")
        CreateESP(player)
    end)
end)
